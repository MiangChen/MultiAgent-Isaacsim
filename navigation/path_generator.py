import toppra as ta
import toppra.constraint as constraint
import toppra.algorithm as algo
import numpy as np

from typing import List, Dict, Any

# 确保 toppra 的日志不会打印过多信息
ta.setup_logging("WARNING")


def generate_trajectory_with_toppra(
        path_points: List[List[float]],
        max_velocity: float,
        max_acceleration: float,
        max_omega: float,
        max_alpha: float,
        sample_rate: int = 50
) -> Dict[str, Any]:
    """
    使用 toppra (v0.6.3) 的标准API为 3D 路径生成带有时间戳、速度和加速度的轨迹。

    Args:
        path_points (List[List[float]]): OMPL规划器输出的路径点列表 [[x,y,z], ...]。
        max_velocity (float): 机器人沿路径的最大线速度 (m/s)。
        max_acceleration (float): 机器人沿路径的最大线加速度/减速度 (m/s^2)。
        max_omega
        max_alpha
        sample_rate (int): 最终轨迹的采样频率 (Hz)，用于生成离散点。

    Returns:
        Dict[str, Any]: 一个包含轨迹信息的字典。
                        如果成功: {'success': True, 'timestamps': [...],
                                     'positions': [...], 'velocities': [...],
                                     'accelerations': [...]}
                        如果失败: {'success': False, 'message': 'Error message'}
    """
    if not path_points or len(path_points) < 2:
        return {"success": False, "message": "Path must contain at least 2 points."}

    path_np = np.array(path_points, dtype=np.float64)
    ss = np.zeros(len(path_np))
    ss[1:] = np.cumsum(np.linalg.norm(np.diff(path_np, axis=0), axis=1))

    path = ta.SplineInterpolator(ss, path_np)
    dof = path.dof  # 对于3D路径, dof = 3

    v_lims = [
        [-max_velocity, max_velocity],  # X
        [-max_velocity, max_velocity],  # Y
        [-max_velocity, max_velocity],  # Z
        [-max_omega, max_omega]  # Yaw
    ]
    con_vel = constraint.JointVelocityConstraint(v_lims)

    a_lims = [
        [-max_acceleration, max_acceleration],  # X
        [-max_acceleration, max_acceleration],  # Y
        [-max_acceleration, max_acceleration],  # Z
        [-max_alpha, max_alpha]  # Yaw
    ]

    con_acc = constraint.JointAccelerationConstraint(a_lims)
    con_acc.set_discretization_type(constraint.DiscretizationType.Interpolation)

    # 实例化求解器，传入正确的约束列表
    instance = algo.TOPPRA([con_vel, con_acc], path, solver_wrapper='seidel')

    traj = instance.compute_trajectory(0, 0)

    if traj is None:
        return {"success": False, "message": "Toppra failed to compute a valid trajectory."}

    duration = traj.duration
    ts_sample = np.linspace(0, duration, int(duration * sample_rate))
    positions = traj(ts_sample, 0).tolist()
    velocities = traj(ts_sample, 1).tolist()
    accelerations = traj(ts_sample, 2).tolist()

    return {
        "success": True,
        "timestamps": ts_sample.tolist(),
        "positions": positions,
        "velocities": velocities,
        "accelerations": accelerations
    }

if __name__ == '__main__':
    # 模拟 OMPL 的输出
    path_yaw_from_ompl = [[6.0, 5.0, 3.0, 0.0], [6.040404040404041, 5.05050505050505, 2.9696969696969697, 0.0], [6.08080808080808, 5.101010101010101, 2.9393939393939394, 0.0], [6.121212121212121, 5.151515151515151, 2.909090909090909, 0.0], [6.161616161616162, 5.202020202020202, 2.878787878787879, 0.0], [6.202020202020202, 5.252525252525253, 2.8484848484848486, 0.0], [6.242424242424242, 5.303030303030303, 2.8181818181818183, 0.0], [6.282828282828283, 5.353535353535354, 2.787878787878788, 0.0], [6.3232323232323235, 5.404040404040404, 2.757575757575758, 0.0], [6.363636363636363, 5.454545454545455, 2.7272727272727275, 0.0], [6.404040404040404, 5.505050505050505, 2.696969696969697, 0.0], [6.444444444444445, 5.555555555555555, 2.6666666666666665, 0.0], [6.484848484848484, 5.606060606060606, 2.6363636363636362, 0.0], [6.525252525252525, 5.656565656565657, 2.606060606060606, 0.0], [6.565656565656566, 5.707070707070707, 2.5757575757575757, 0.0], [6.606060606060606, 5.757575757575758, 2.5454545454545454, 0.0], [6.646464646464646, 5.808080808080808, 2.515151515151515, 0.0], [6.686868686868687, 5.858585858585858, 2.484848484848485, 0.0], [6.7272727272727275, 5.909090909090909, 2.4545454545454546, 0.0], [6.767676767676767, 5.959595959595959, 2.4242424242424243, 0.0], [6.808080808080808, 6.01010101010101, 2.393939393939394, 0.0], [6.848484848484849, 6.0606060606060606, 2.3636363636363638, 0.0], [6.888888888888889, 6.111111111111111, 2.3333333333333335, 0.0], [6.929292929292929, 6.161616161616162, 2.3030303030303028, 0.0], [6.96969696969697, 6.212121212121212, 2.2727272727272725, 0.0], [7.01010101010101, 6.262626262626263, 2.242424242424242, 0.0], [7.05050505050505, 6.313131313131313, 2.212121212121212, 0.0], [7.090909090909091, 6.363636363636363, 2.1818181818181817, 0.0], [7.1313131313131315, 6.414141414141414, 2.1515151515151514, 0.0], [7.171717171717171, 6.4646464646464645, 2.121212121212121, 0.0], [7.212121212121212, 6.515151515151516, 2.090909090909091, 0.0], [7.252525252525253, 6.565656565656566, 2.0606060606060606, 0.0], [7.292929292929293, 6.616161616161616, 2.0303030303030303, 0.0], [7.333333333333333, 6.666666666666666, 2.0, 0.0], [7.373737373737374, 6.717171717171717, 1.9696969696969697, 0.0], [7.414141414141414, 6.767676767676768, 1.9393939393939394, 0.0], [7.454545454545455, 6.818181818181818, 1.9090909090909092, 0.0], [7.494949494949495, 6.8686868686868685, 1.8787878787878787, 0.0], [7.5353535353535355, 6.919191919191919, 1.8484848484848486, 0.0], [7.575757575757576, 6.96969696969697, 1.8181818181818183, 0.0], [7.616161616161616, 7.020202020202021, 1.7878787878787878, 0.0], [7.656565656565657, 7.070707070707071, 1.7575757575757576, 0.0], [7.696969696969697, 7.121212121212121, 1.7272727272727273, 0.0], [7.737373737373737, 7.171717171717171, 1.6969696969696968, 0.0], [7.777777777777778, 7.222222222222222, 1.6666666666666667, 0.0], [7.818181818181818, 7.2727272727272725, 1.6363636363636365, 0.0], [7.858585858585858, 7.3232323232323235, 1.606060606060606, 0.0], [7.898989898989899, 7.373737373737374, 1.5757575757575757, 0.0], [7.9393939393939394, 7.424242424242424, 1.5454545454545454, 0.0], [7.97979797979798, 7.474747474747475, 1.5151515151515151, 0.0], [8.02020202020202, 7.525252525252526, 1.4848484848484849, 0.0], [8.06060606060606, 7.575757575757576, 1.4545454545454546, 0.0], [8.1010101010101, 7.626262626262626, 1.424242424242424, 0.0], [8.141414141414142, 7.6767676767676765, 1.393939393939394, 0.0], [8.181818181818182, 7.727272727272727, 1.3636363636363638, 0.0], [8.222222222222221, 7.777777777777778, 1.3333333333333333, 0.0], [8.262626262626263, 7.828282828282829, 1.3030303030303032, 0.0], [8.303030303030303, 7.878787878787879, 1.2727272727272725, 0.0], [8.343434343434343, 7.929292929292929, 1.2424242424242424, 0.0], [8.383838383838384, 7.979797979797979, 1.2121212121212124, 0.0], [8.424242424242424, 8.030303030303031, 1.1818181818181817, 0.0], [8.464646464646464, 8.08080808080808, 1.1515151515151516, 0.0], [8.505050505050505, 8.131313131313131, 1.121212121212121, 0.0], [8.545454545454545, 8.181818181818182, 1.0909090909090908, 0.0], [8.585858585858587, 8.232323232323232, 1.0606060606060606, 0.0], [8.626262626262626, 8.282828282828284, 1.0303030303030303, 0.0], [8.666666666666666, 8.333333333333332, 1.0, 0.0], [8.707070707070708, 8.383838383838384, 0.9696969696969697, 0.0], [8.747474747474747, 8.434343434343434, 0.9393939393939394, 0.0], [8.787878787878789, 8.484848484848484, 0.9090909090909092, 0.0], [8.828282828282829, 8.535353535353536, 0.8787878787878789, 0.0], [8.868686868686869, 8.585858585858585, 0.8484848484848486, 0.0], [8.90909090909091, 8.636363636363637, 0.8181818181818183, 0.0], [8.94949494949495, 8.686868686868687, 0.7878787878787881, 0.0], [8.98989898989899, 8.737373737373737, 0.7575757575757573, 0.0], [9.030303030303031, 8.787878787878789, 0.7272727272727275, 0.0], [9.070707070707071, 8.838383838383837, 0.6969696969696972, 0.0], [9.11111111111111, 8.88888888888889, 0.6666666666666665, 0.0], [9.151515151515152, 8.93939393939394, 0.6363636363636367, 0.0], [9.191919191919192, 8.98989898989899, 0.606060606060606, 0.0], [9.232323232323232, 9.040404040404042, 0.5757575757575757, 0.0], [9.272727272727273, 9.09090909090909, 0.5454545454545454, 0.0], [9.313131313131313, 9.141414141414142, 0.5151515151515151, 0.0], [9.353535353535353, 9.191919191919192, 0.48484848484848486, 0.0], [9.393939393939394, 9.242424242424242, 0.4545454545454546, 0.0], [9.434343434343434, 9.292929292929292, 0.4242424242424243, 0.0], [9.474747474747474, 9.343434343434343, 0.3939393939393936, 0.0], [9.515151515151516, 9.393939393939394, 0.36363636363636376, 0.0], [9.555555555555555, 9.444444444444445, 0.3333333333333335, 0.0], [9.595959595959595, 9.494949494949495, 0.30303030303030276, 0.0], [9.636363636363637, 9.545454545454545, 0.27272727272727293, 0.0], [9.676767676767676, 9.595959595959595, 0.2424242424242422, 0.0], [9.717171717171716, 9.646464646464647, 0.21212121212121193, 0.0], [9.757575757575758, 9.696969696969697, 0.18181818181818166, 0.0], [9.797979797979798, 9.747474747474747, 0.15151515151515138, 0.0], [9.838383838383837, 9.797979797979798, 0.1212121212121211, 0.0], [9.878787878787879, 9.848484848484848, 0.09090909090909083, 0.0], [9.919191919191919, 9.8989898989899, 0.06060606060606055, 0.0], [9.95959595959596, 9.94949494949495, 0.030303030303030276, 0.0], [10.0, 10.0, 0.0, 0.0]]

    print(f"从OMPL获得 {len(path_yaw_from_ompl)} 个路径点。")
    print("-" * 30)

    # 模拟机器人动力学参数
    robot_dynamics = {
        "max_velocity": 1.5,
        "max_acceleration": 0.8,
        "max_omega": 1,
        "max_alpha": 1.5,
    }
    print("机器人动力学参数:")
    print(robot_dynamics)
    print("-" * 30)

    # --- 调用最终正确的函数 ---
    trajectory_data = generate_trajectory_with_toppra(
        path_points=path_yaw_from_ompl,
        **robot_dynamics
    )

    import matplotlib
    matplotlib.use('TkAgg')  # 或者其他可用的后端，如Qt5Agg
    import matplotlib.pyplot as plt

    # --- 处理和验证结果 (与之前相同) ---
    if trajectory_data["success"]:
        timestamps = trajectory_data["timestamps"]
        velocities = np.array(trajectory_data["velocities"])
        velocity_magnitudes = np.linalg.norm(velocities, axis=1)

        print("Toppra 成功生成轨迹！")
        print(f"  轨迹总时长: {timestamps[-1]:.2f} 秒")
        print(f"  采样点数量: {len(timestamps)}")
        print(f"  计算出的最大速度: {np.max(velocity_magnitudes):.2f} m/s (注意: 这不直接等于max_velocity)")
        print("traj data", trajectory_data.keys())
        print("traj data vel", len(trajectory_data['velocities'][0]))
        plt.figure(figsize=(12, 6))
        plt.plot(timestamps, velocity_magnitudes, marker='.', linestyle='-')
        plt.title("Trajectory Velocity Profile")
        plt.xlabel("Time (s)")
        plt.ylabel("Velocity Magnitude (m/s)")
        plt.axhline(y=robot_dynamics['max_velocity'], color='r', linestyle='--',
                    label=f'Velocity Limit on Path Derivatives')
        plt.grid(True)
        plt.legend()

        plt.show()
    else:
        print(f"轨迹生成失败: {trajectory_data['message']}")
